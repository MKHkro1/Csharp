
```C#
using System;

using System.Collections.Generic;

using System.Reflection;

using System.Text;

using BepInEx;

using BepInEx.Unity.IL2CPP;

using CustomizeLib.BepInEx;

using HarmonyLib;

using Il2CppInterop.Runtime.Injection;

using UnityEngine;

  

namespace WaterPot.BepInEx

{

    [BepInPlugin("inf75.waterpot", "WaterPot", "1.0.0")]

    public class Core : BasePlugin

    {

        public const int PlantID = 2012;

  

        private const int PLANT_TOUGHNESS = 300;

        private const float PLANT_COOLDOWN = 7.5f;

        private const int PLANT_SUN_COST = 25;

  

        public override void Load()

        {

            Console.OutputEncoding = Encoding.UTF8;

  

            Harmony.CreateAndPatchAll(Assembly.GetExecutingAssembly());

            ClassInjector.RegisterTypeInIl2Cpp<WaterPotComponent>();

  

            AssetBundle bundle = CustomCore.GetAssetBundle(Assembly.GetExecutingAssembly(), "waterpot");

            if (bundle == null)

            {

                Log.LogError("[WaterPot] 资源包 waterpot 加载失败——请确认已正确配置 EmbeddedResource。");

                return;

            }

  

            GameObject prefab = bundle.GetAsset<GameObject>("WaterPotPrefab");

            GameObject preview = bundle.GetAsset<GameObject>("WaterPotPreview");

  

            if (prefab == null || preview == null)

            {

                Log.LogError("[WaterPot] 无法从 assetbundle 读取 WaterPotPrefab/WaterPotPreview，请检查资源名称。");

                return;

            }

  

            CustomCore.RegisterCustomPlant<Plant, WaterPotComponent>(

                PlantID,

                prefab,

                preview,

                new List<(int, int)>(),

                attackInterval: 0f,

                produceInterval: 0f,

                attackDamage: 0,

                maxHealth: PLANT_TOUGHNESS,

                cd: PLANT_COOLDOWN,

                sun: PLANT_SUN_COST);

  

            if (!CustomCore.TypeMgrExtra.IsPot.Contains((PlantType)PlantID))

            {

                CustomCore.TypeMgrExtra.IsPot.Add((PlantType)PlantID);

            }

  

            CustomCore.RegisterCustomCardToColorfulCards((PlantType)PlantID);

  

            string name = $"水盆 ({PlantID})";

            string description =

                "水上植物的“花盆”基座。" +

                "\n\n" +

                "<color=#3D1400>作者：</color><color=red>梧萱梦汐X、红烧黛鱼</color>" +

                "\n<color=#3D1400>韧性：</color><color=red>300</color>" +

                "\n<color=#3D1400>消耗：</color><color=red>25</color>" +

                "\n<color=#3D1400>冷却：</color><color=red>7.5秒</color>" +

                "\n\n<color=green>【效果】</color>" +

                "\n承载水生植物的花盆";

  

            CustomCore.AddPlantAlmanacStrings(PlantID, name, description);

  

            Log.LogInfo("[WaterPot] 插件加载完成。");

        }

    }

  

    public class WaterPotComponent : MonoBehaviour

    {

        private Plant? _selfPlant;

        private Plant? _currentRider;

        private float _nextCheckTime;

        private readonly Dictionary<IntPtr, RiderState> _riderStates = new();

  

        public WaterPotComponent(IntPtr ptr) : base(ptr)

        {

        }

  

        private void Awake()

        {

            try

            {

                _selfPlant = GetComponent<Plant>();

                if (_selfPlant != null)

                {

                    _selfPlant.alwaysLightUp = true;

                }

            }

            catch (Exception ex)

            {

                Debug.LogWarning($"[WaterPot] 初始化失败: {ex.Message}");

            }

        }

  

        private void OnDestroy()

        {

            ReleaseRider();

        }

  

        private void Update()

        {

            if (_selfPlant == null || Board.Instance == null)

            {

                ReleaseRider();

                return;

            }

  

            if (_nextCheckTime > Time.time)

            {

                if (_currentRider != null)

                {

                    EnsureRiderState(_currentRider);

                }

                return;

            }

  

            _nextCheckTime = Time.time + 0.25f;

            SyncRider();

        }

  

        private void SyncRider()

        {

            Plant? rider = FindRider();

  

            if (rider == _currentRider)

            {

                if (rider != null)

                {

                    EnsureRiderState(rider);

                }

                return;

            }

  

            if (_currentRider != null)

            {

                ResetRiderState(_currentRider);

            }

  

            _currentRider = rider;

  

            if (_currentRider != null)

            {

                ApplyRiderState(_currentRider);

            }

        }

  

        private Plant? FindRider()

        {

            if (_selfPlant == null)

            {

                return null;

            }

  

            var plants = Lawnf.Get1x1Plants(_selfPlant.thePlantColumn, _selfPlant.thePlantRow);

            if (plants == null || plants.Count == 0)

            {

                return null;

            }

  

            for (int i = 0; i < plants.Count; i++)

            {

                var plant = plants[i];

                if (plant == null || plant == _selfPlant)

                {

                    continue;

                }

  

                if (!TypeMgr.IsWaterPlant(plant.thePlantType))

                {

                    continue;

                }

  

                return plant;

            }

  

            return null;

        }

  

        private void ReleaseRider()

        {

            if (_currentRider != null)

            {

                ResetRiderState(_currentRider);

                _currentRider = null;

            }

        }

  

        private class RiderState

        {

            public bool OriginalIsLily;

            public PlantType OriginalLilyType;

            public bool OriginalWaterTag;

        }

  

        private RiderState GetOrCreateState(Plant rider)

        {

            IntPtr key = rider.Pointer;

            if (!_riderStates.TryGetValue(key, out var state))

            {

                state = new RiderState

                {

                    OriginalIsLily = rider.isLily,

                    OriginalLilyType = rider.theLilyType,

                    OriginalWaterTag = rider.plantTag.waterPlant

                };

                _riderStates[key] = state;

            }

  

            return state;

        }

  

        private void RemoveState(Plant rider)

        {

            IntPtr key = rider.Pointer;

            if (_riderStates.ContainsKey(key))

            {

                _riderStates.Remove(key);

            }

        }

  

        private void ApplyRiderState(Plant rider)

        {

            try

            {

                GetOrCreateState(rider);

                EnsureRiderWaterlessTag(rider);

            }

            catch { }

        }

  

        private void EnsureRiderState(Plant rider)

        {

            GetOrCreateState(rider);

  

            EnsureRiderWaterlessTag(rider);

        }

  

        private static void EnsureRiderWaterlessTag(Plant rider)

        {

            var tag = rider.plantTag;

            if (!tag.waterPlant)

            {

                return;

            }

  

            tag.waterPlant = false;

            rider.plantTag = tag;

        }

  

        private void ResetRiderState(Plant rider)

        {

            try

            {

                if (_riderStates.TryGetValue(rider.Pointer, out var state))

                {

                    rider.isLily = state.OriginalIsLily;

                    rider.theLilyType = state.OriginalLilyType;

                    var tag = rider.plantTag;

                    tag.waterPlant = state.OriginalWaterTag;

                    rider.plantTag = tag;

                }

                else

                {

                    rider.isLily = false;

                    if (rider.theLilyType == PlantType.LilyPad)

                    {

                        rider.theLilyType = PlantType.Nothing;

                    }

                    var tag = rider.plantTag;

                    tag.waterPlant = TypeMgr.IsWaterPlant(rider.thePlantType);

                    rider.plantTag = tag;

                }

  

                RemoveState(rider);

            }

            catch { }

        }

    }

}
```


```C#
using UnityEngine;

  

namespace WaterPot.BepInEx

{

    internal static class WaterPotGridUtility

    {

  

        public static bool ContainsWaterPotAt(int column, int row)

        {

            if (column < 0 || row < 0)

            {

                return false;

            }

  

            Il2CppSystem.Collections.Generic.List<Plant>? plants = null;

  

            try

            {

                plants = Lawnf.Get1x1Plants(column, row);

            }

            catch

            {

                return false;

            }

  

            if (plants == null || plants.Count == 0)

            {

                return false;

            }

  

            for (int i = plants.Count - 1; i >= 0; i--)

            {

                var plant = plants[i];

                if (plant == null)

                {

                    continue;

                }

  

                if (plant.thePlantType == (PlantType)Core.PlantID)

                {

                    return true;

                }

            }

  

            return false;

        }

  

        public static bool HasWaterPotNearby(int column, int row, int detectionRange = 1)

        {

            if (Board.Instance == null)

            {

                return false;

            }

  

            if (detectionRange < 0)

            {

                detectionRange = 0;

            }

  

            for (int dc = -detectionRange; dc <= detectionRange; dc++)

            {

                for (int dr = -detectionRange; dr <= detectionRange; dr++)

                {

                    if (ContainsWaterPotAt(column + dc, row + dr))

                    {

                        return true;

                    }

                }

            }

  

            return false;

        }

    }

}
```

```C#
using System;

using System.Collections.Generic;

using HarmonyLib;

using UnityEngine;

  

namespace WaterPot.BepInEx

{

    internal static class WaterPotPlacementBypass

    {

        [ThreadStatic]

        private static bool s_active;

  

        [ThreadStatic]

        private static PlantType s_targetType;

  

        public static void Begin(PlantType plantType)

        {

            s_active = true;

            s_targetType = plantType;

        }

  

        public static void End()

        {

            s_active = false;

            s_targetType = default;

        }

  

        public static bool ShouldIgnore(PlantType plantType) => s_active && plantType == s_targetType;

    }

  

    internal static class WaterPotFusionBypass

    {

        [ThreadStatic]

        private static HashSet<PlantType>? s_ignoredTypes;

  

        [ThreadStatic]

        private static bool s_active;

  

        public static void Begin(IEnumerable<PlantType> plantTypes)

        {

            s_active = true;

            s_ignoredTypes ??= new HashSet<PlantType>();

            s_ignoredTypes.Clear();

            foreach (var type in plantTypes)

            {

                s_ignoredTypes.Add(type);

            }

        }

  

        public static void End()

        {

            s_active = false;

            s_ignoredTypes?.Clear();

        }

  

        public static bool ShouldIgnore(PlantType plantType) =>

            s_active && s_ignoredTypes != null && s_ignoredTypes.Contains(plantType);

    }

  

    [HarmonyPatch(typeof(Mouse), nameof(Mouse.LeftClickWithSomeThing))]

    internal static class Mouse_LeftClickWithSomeThing_Patch

    {

        [HarmonyPrefix]

        public static void Prefix(Mouse __instance, ref bool __state)

        {

            __state = false;

  

            if (__instance == null)

            {

                return;

            }

  

            PlantType plantingType = __instance.thePlantTypeOnMouse;

            if ((int)plantingType < 0)

            {

                return;

            }

  

            if (!TypeMgr.IsWaterPlant(plantingType))

            {

                return;

            }

  

            var camera = Camera.main;

            if (camera == null)

            {

                return;

            }

  

            Vector3 worldPos = camera.ScreenToWorldPoint(UnityEngine.Input.mousePosition);

            RaycastHit2D[] hits = Physics2D.RaycastAll(worldPos, Vector2.zero);

            if (hits == null || hits.Length == 0)

            {

                return;

            }

  

            bool hasWaterPot = false;

            HashSet<Plant> inspected = new();

  

            foreach (var hit in hits)

            {

                var collider = hit.collider;

                if (collider == null)

                {

                    continue;

                }

  

                if (!collider.TryGetComponent(out Plant plant))

                {

                    continue;

                }

  

                if (!inspected.Add(plant))

                {

                    continue;

                }

  

                if (plant.thePlantType == (PlantType)Core.PlantID)

                {

                    hasWaterPot = true;

                    continue;

                }

  

                if (plant.plantTag.pumpkinPlant)

                {

                    continue;

                }

  

                // 同格存在其它植物，仍按原始规则处理

                return;

            }

  

            if (hasWaterPot)

            {

                WaterPotPlacementBypass.Begin(plantingType);

                __state = true;

            }

        }

  

        [HarmonyPostfix]

        public static void Postfix(bool __state)

        {

            if (__state)

            {

                WaterPotPlacementBypass.End();

            }

        }

    }

  

    [HarmonyPatch(typeof(TypeMgr), nameof(TypeMgr.IsWaterPlant))]

    internal static class TypeMgr_IsWaterPlant_Patch

    {

        [HarmonyPostfix]

        public static void Postfix(PlantType theSeedType, ref bool __result)

        {

            if (__result &&

                (WaterPotPlacementBypass.ShouldIgnore(theSeedType) ||

                 WaterPotFusionBypass.ShouldIgnore(theSeedType)))

            {

                __result = false;

            }

        }

    }

  

    [HarmonyPatch(typeof(CreatePlant), nameof(CreatePlant.CheckMix))]

    internal static class CreatePlant_CheckMix_WaterPotPatch

    {

        [HarmonyPrefix]

        public static void Prefix(int theColumn, int theRow)

        {

            if (!TryCollectOverrideTypes(theColumn, theRow, out var types))

            {

                WaterPotFusionBypass.End();

                return;

            }

  

            WaterPotFusionBypass.Begin(types!);

        }

  

        [HarmonyPostfix]

        public static void Postfix()

        {

            WaterPotFusionBypass.End();

        }

  

        internal static bool TryCollectOverrideTypes(int column, int row, out List<PlantType>? types)

        {

            types = null;

            var plants = Lawnf.Get1x1Plants(column, row);

            if (plants == null || plants.Count == 0)

            {

                return false;

            }

  

            bool hasWaterPot = false;

  

            for (int i = 0; i < plants.Count; i++)

            {

                var plant = plants[i];

                if (plant == null)

                {

                    continue;

                }

  

                if (plant.thePlantType == (PlantType)Core.PlantID)

                {

                    hasWaterPot = true;

                    continue;

                }

  

                if (TypeMgr.IsWaterPlant(plant.thePlantType))

                {

                    types ??= new List<PlantType>();

                    types.Add(plant.thePlantType);

                }

            }

  

            return hasWaterPot && types != null && types.Count > 0;

        }

    }

  

    [HarmonyPatch(typeof(CreatePlant), nameof(CreatePlant.MixFail))]

    internal static class CreatePlant_MixFail_WaterPotPatch

    {

        [HarmonyPrefix]

        public static bool Prefix(int theBoxColumn, int theBoxRow, int newPlantType, ref bool __result, ref bool __state)

        {

            var plantType = (PlantType)newPlantType;

            bool isWaterPlant = TypeMgr.IsWaterPlant(plantType);

            bool hasWaterPot = WaterPotGridUtility.ContainsWaterPotAt(theBoxColumn, theBoxRow);

  

            if (isWaterPlant && hasWaterPot)

            {

                __result = false;

                return false;

            }

  

            if (!CreatePlant_CheckMix_WaterPotPatch.TryCollectOverrideTypes(theBoxColumn, theBoxRow, out var types))

            {

                WaterPotFusionBypass.End();

                __state = false;

                return true;

            }

  

            WaterPotFusionBypass.Begin(types!);

            __state = true;

            return true;

        }

  

        [HarmonyPostfix]

        public static void Postfix(bool __state)

        {

            if (__state)

            {

                WaterPotFusionBypass.End();

            }

        }

    }

  

    [HarmonyPatch(typeof(CreatePlant), nameof(CreatePlant.CheckBox))]

    internal static class CreatePlant_CheckBox_WaterPotRestrictionPatch

    {

        [HarmonyPrefix]

        public static bool Prefix(int theBoxColumn, int theBoxRow, int theSeedType, ref bool __result, ref bool __state)

        {

            __state = false;

            if (!WaterPotGridUtility.ContainsWaterPotAt(theBoxColumn, theBoxRow))

            {

                return true;

            }

  

            var plantType = (PlantType)theSeedType;

  

            if (plantType == (PlantType)Core.PlantID)

            {

                return true;

            }

  

            if (TypeMgr.IsWaterPlant(plantType))

            {

                WaterPotPlacementBypass.Begin(plantType);

                __state = true;

                return true;

            }

  

            if (IsWaterPlantIgnoringBypass(plantType))

            {

                return true;

            }

  

            InGameText.Instance?.ShowText("只能在水盆上种植水生植物", 3f);

            __result = false;

            return false;

        }

  

        private static bool IsWaterPlantIgnoringBypass(PlantType plantType)

        {

            if (WaterPotPlacementBypass.ShouldIgnore(plantType) ||

                WaterPotFusionBypass.ShouldIgnore(plantType))

            {

                return true;

            }

  

            return TypeMgr.IsWaterPlant(plantType);

        }

  

        [HarmonyPostfix]

        public static void Postfix(bool __state)

        {

            if (__state)

            {

                WaterPotPlacementBypass.End();

            }

        }

    }

  

    [HarmonyPatch(typeof(Board), nameof(Board.GetBoxType))]

    internal static class Board_GetBoxType_WaterPotPatch

    {

        private const int WaterBoxValue = 2;

  

        [HarmonyPostfix]

        public static void Postfix(int theColumn, int theRow, ref BoxType __result)

        {

            if ((int)__result == WaterBoxValue)

            {

                return;

            }

  

            if (WaterPotGridUtility.ContainsWaterPotAt(theColumn, theRow))

            {

                __result = (BoxType)WaterBoxValue;

            }

        }

    }

}
```

```C#
using System;

using HarmonyLib;

using Il2CppInterop.Runtime.InteropTypes.Arrays;

using UnityEngine;

  

namespace WaterPot.BepInEx

{

    internal static class WaterPotRemovalHelper

    {

        public static bool TryHandleShovelFallback()

        {

            var mouse = Mouse.Instance;

            if (mouse == null)

            {

                return false;

            }

  

            var itemOnMouse = mouse.theItemOnMouse;

            if (itemOnMouse == null || itemOnMouse.name != "Shovel")

            {

                return false;

            }

  

            var camera = Camera.main;

            if (camera == null)

            {

                return false;

            }

  

            Vector3 worldPos = camera.ScreenToWorldPoint(UnityEngine.Input.mousePosition);

            RaycastHit2D[] hits = Physics2D.RaycastAll(worldPos, Vector2.zero);

            if (hits == null || hits.Length == 0)

            {

                return false;

            }

  

            Plant? potPlant = null;

            Plant? topPlant = null;

  

            foreach (var hit in hits)

            {

                var collider = hit.collider;

                if (collider == null)

                {

                    continue;

                }

  

                if (!collider.TryGetComponent(out Plant plant))

                {

                    continue;

                }

  

                if (plant == null)

                {

                    continue;

                }

  

                if (plant.thePlantType == (PlantType)Core.PlantID)

                {

                    potPlant ??= plant;

                    continue;

                }

  

                if (topPlant == null)

                {

                    topPlant = plant;

                }

            }

  

            if (potPlant == null)

            {

                return false;

            }

  

            try

            {

                if (topPlant != null)

                {

                    topPlant.Die(Plant.DieReason.ByShovel);

                }

                else

                {

                    potPlant.Die(Plant.DieReason.ByShovel);

                }

  

                return true;

            }

            catch (Exception ex)

            {

                Debug.LogError($"[WaterPot] Shovel fallback failed: {ex}");

                return false;

            }

        }

    }

  

    [HarmonyPatch(typeof(Mouse), nameof(Mouse.GetPlantsOnMouse))]

    internal static class Mouse_GetPlantsOnMouse_Patch

    {

        [HarmonyPrefix]

        public static bool Prefix(ref Il2CppStructArray<RaycastHit2D> hits, ref Il2CppSystem.Collections.Generic.List<Plant> __result)

        {

            __result = BuildPlantsUnderMouse();

            return false;

        }

  

        private static Il2CppSystem.Collections.Generic.List<Plant> BuildPlantsUnderMouse()

        {

            var list = new Il2CppSystem.Collections.Generic.List<Plant>();

            var camera = Camera.main;

            if (camera == null)

            {

                return list;

            }

  

            Vector3 worldPos = camera.ScreenToWorldPoint(UnityEngine.Input.mousePosition);

            RaycastHit2D[] managedHits = Physics2D.RaycastAll(worldPos, Vector2.zero);

            if (managedHits == null || managedHits.Length == 0)

            {

                return list;

            }

  

            foreach (var managedHit in managedHits)

            {

                var collider = managedHit.collider;

                if (collider == null)

                {

                    continue;

                }

  

                if (!collider.TryGetComponent(out Plant plant) || plant == null)

                {

                    continue;

                }

  

                bool exists = false;

                for (int i = 0; i < list.Count; i++)

                {

                    if (list[i] == plant)

                    {

                        exists = true;

                        break;

                    }

                }

  

                if (!exists)

                {

                    list.Add(plant);

                }

            }

  

            return list;

        }

    }

  

    [HarmonyPatch(typeof(Mouse), nameof(Mouse.GetPlantsOnMouse))]

    internal static class Mouse_GetPlantsOnMouse_FilterWaterPotPatch

    {

        [HarmonyPostfix]

        public static void Postfix(ref Il2CppSystem.Collections.Generic.List<Plant> __result)

        {

            if (__result == null || __result.Count <= 1)

            {

                return;

            }

  

            for (int i = __result.Count - 1; i >= 0; i--)

            {

                var candidate = __result[i];

                if (candidate == null || candidate.thePlantType != (PlantType)Core.PlantID)

                {

                    continue;

                }

  

                bool hasOtherSameCell = false;

                for (int j = 0; j < __result.Count; j++)

                {

                    if (i == j)

                    {

                        continue;

                    }

  

                    var other = __result[j];

                    if (other == null)

                    {

                        continue;

                    }

  

                    if (other.thePlantColumn == candidate.thePlantColumn &&

                        other.thePlantRow == candidate.thePlantRow)

                    {

                        hasOtherSameCell = true;

                        break;

                    }

                }

  

                if (hasOtherSameCell)

                {

                    __result.RemoveAt(i);

                }

            }

        }

    }

  

    [HarmonyPatch(typeof(Mouse), nameof(Mouse.LeftClickWithSomeThing))]

    internal static class Mouse_LeftClickWithSomeThing_Finalizer

    {

        [HarmonyFinalizer]

        public static Exception? Finalizer(Exception __exception)

        {

            if (__exception is NullReferenceException && WaterPotRemovalHelper.TryHandleShovelFallback())

            {

                return null;

            }

  

            return __exception;

        }

    }

  

    [HarmonyPatch(typeof(Garden))]

    internal static class Garden_IsWaterBox_Patch

    {

        [HarmonyPrefix]

        [HarmonyPatch(nameof(Garden.IsWaterBox), typeof(int), typeof(int))]

        public static bool PrefixInt(Garden __instance, int theColumn, int theRow, ref bool __result)

        {

            if (WaterPotGridUtility.HasWaterPotNearby(theColumn, theRow))

            {

                __result = true;

                return false;

            }

  

            return true;

        }

  

        [HarmonyPrefix]

        [HarmonyPatch(nameof(Garden.IsWaterBox), typeof(Vector3Int))]

        public static bool PrefixVector(Garden __instance, Vector3Int box, ref bool __result)

        {

            if (WaterPotGridUtility.HasWaterPotNearby(box.x, box.y))

            {

                __result = true;

                return false;

            }

  

            return true;

        }

    }

}
```