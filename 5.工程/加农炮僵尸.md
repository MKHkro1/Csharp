```
using System;

using System.Collections;

using BepInEx;

using BepInEx.Core.Logging.Interpolation;

using BepInEx.Logging;

using BepInEx.Unity.IL2CPP;

using HarmonyLib;

using Il2CppInterop.Runtime.InteropTypes.Arrays;

using Il2CppSystem;

using Il2CppSystem.Collections.Generic;

using TMPro;

using UnityEngine;

  

namespace CannonGargantuar

{

    [BepInPlugin("CannonGargantuar", "CannonGargantuar", "1.0.0")]

    public class Plugin : BasePlugin

    {

        internal static ManualLogSource Logger;

        public static AssetBundle AssetBundle;

        public static ZombieType CobCannonGargantuarType;

        public static ZombieType MelonCannonGargantuarType;

        public static BulletType CobCannonBulletType;

        public static BulletType MelonCannonBulletType;

  

        public override void Load()

        {

            Logger = Log;

            try

            {

                var harmony = new Harmony("CannonGargantuar");

                harmony.PatchAll();

                Logger.LogInfo("CannonGargantuar plugin loaded successfully!");

                LoadCannonGargantuar();

            }

            catch (Exception ex)

            {

                Logger.LogError($"Failed to load CannonGargantuar: {ex.Message}");

            }

        }

  

        public static AssetBundle LoadAssetBundle(string base64String, string path = "")

        {

            try

            {

                byte[] data = Convert.FromBase64String(base64String);

                return AssetBundle.LoadFromMemory(data);

            }

            catch (Exception ex)

            {

                Logger.LogError($"Failed to load asset bundle: {ex.Message}");

                return null;

            }

        }

  

        public static Sprite LoadSpriteFromBase64(string base64String)

        {

            try

            {

                byte[] data = Convert.FromBase64String(base64String);

                Texture2D texture = new Texture2D(2, 2);

                if (texture.LoadImage(data))

                {

                    return Sprite.Create(texture, new Rect(0, 0, texture.width, texture.height), new Vector2(0.5f, 0.5f));

                }

                return null;

            }

            catch (Exception ex)

            {

                Logger.LogError($"Failed to load sprite: {ex.Message}");

                return null;

            }

        }

  

        public static void LoadCannonGargantuar()

        {

            try

            {

                // 加载资源包并创建新的僵尸和子弹类型

                AssetBundle = LoadAssetBundle("YOUR_ASSET_BUNDLE_BASE64_HERE");

                if (AssetBundle != null)

                {

                    // 从资源包加载所有资源

                    UnityEngine.Object[] allAssets = AssetBundle.LoadAllAssets();

                    foreach (var asset in allAssets)

                    {

                        string assetName = asset.name;

                        // 根据资源名称创建相应的游戏对象

                        if (assetName.Contains("CobCannonGargantuar"))

                        {

                            // 创建玉米加农炮巨人

                            CreateNewZombieType(asset as GameObject, ZombieType.gargantuar);

                        }

                        else if (assetName.Contains("MelonCannonGargantuar"))

                        {

                            // 创建西瓜加农炮巨人  

                            CreateNewZombieType(asset as GameObject, ZombieType.gargantuar);

                        }

                        else if (assetName.Contains("CobCannonBullet"))

                        {

                            // 创建玉米加农炮子弹

                            CreateNewBulletType(asset as GameObject);

                        }

                        else if (assetName.Contains("MelonCannonBullet"))

                        {

                            // 创建西瓜加农炮子弹

                            CreateNewBulletType(asset as GameObject);

                        }

                    }

                    Logger.LogInfo("Cannon Gargantuar assets loaded successfully!");

                }

            }

            catch (Exception ex)

            {

                Logger.LogError($"Failed to load Cannon Gargantuar: {ex.Message}");

            }

        }

  

        private static void CreateNewZombieType(GameObject zombiePrefab, ZombieType baseType)

        {

            if (zombiePrefab == null) return;

            try

            {

                var resourcesManager = GetResourcesManager();

                if (resourcesManager != null)

                {

                    // 获取僵尸类型列表并添加新类型

                    List<ZombieType> zombieTypes = GetZombieTypes(resourcesManager);

                    Dictionary<ZombieType, GameObject> zombiePrefabs = GetZombiePrefabs(resourcesManager);

                    // 创建新的僵尸类型枚举值

                    ZombieType newType = (ZombieType)Enum.Parse(typeof(ZombieType), zombiePrefab.name);

                    // 添加到游戏系统中

                    if (!zombieTypes.Contains(newType))

                    {

                        zombieTypes.Add(newType);

                        zombiePrefabs[newType] = zombiePrefab;

                        // 添加到僵尸数据管理器

                        var zombieDataDict = GetZombieDataDictionary();

                        if (zombieDataDict != null && !zombieDataDict.ContainsKey(newType))

                        {

                            // 复制基础类型的僵尸数据并修改

                            if (zombieDataDict.ContainsKey(baseType))

                            {

                                var baseData = zombieDataDict[baseType];

                                // 创建新的僵尸数据...

                            }

                        }

                        Logger.LogInfo($"Created new zombie type: {newType}");

                    }

                }

            }

            catch (Exception ex)

            {

                Logger.LogError($"Failed to create new zombie type: {ex.Message}");

            }

        }

  

        private static void CreateNewBulletType(GameObject bulletPrefab)

        {

            if (bulletPrefab == null) return;

            try

            {

                var resourcesManager = GetResourcesManager();

                if (resourcesManager != null)

                {

                    // 获取子弹类型列表并添加新类型

                    List<BulletType> bulletTypes = GetBulletTypes(resourcesManager);

                    Dictionary<BulletType, GameObject> bulletPrefabs = GetBulletPrefabs(resourcesManager);

                    // 创建新的子弹类型枚举值

                    BulletType newType = (BulletType)Enum.Parse(typeof(BulletType), bulletPrefab.name);

                    if (!bulletTypes.Contains(newType))

                    {

                        bulletTypes.Add(newType);

                        bulletPrefabs[newType] = bulletPrefab;

                        Logger.LogInfo($"Created new bullet type: {newType}");

                    }

                }

            }

            catch (Exception ex)

            {

                Logger.LogError($"Failed to create new bullet type: {ex.Message}");

            }

        }

  

        // 辅助方法 - 这些需要根据实际游戏API进行调整

        private static ResourcesManager GetResourcesManager()

        {

            return ResourcesManager.Instance;

        }

  

        private static List<ZombieType> GetZombieTypes(ResourcesManager manager)

        {

            return manager.zombieTypes;

        }

  

        private static Dictionary<ZombieType, GameObject> GetZombiePrefabs(ResourcesManager manager)

        {

            return manager.zombiePrefabs;

        }

  

        private static List<BulletType> GetBulletTypes(ResourcesManager manager)

        {

            return manager.bulletTypes;

        }

  

        private static Dictionary<BulletType, GameObject> GetBulletPrefabs(ResourcesManager manager)

        {

            return manager.bulletPrefabs;

        }

  

        private static Dictionary<ZombieType, ZombieDataManager.ZombieData> GetZombieDataDictionary()

        {

            return ZombieDataManager.Instance.zombieDataDict;

        }

  

        // 玉米加农炮巨人行为类

        public class CobCannonGargantuar : MonoBehaviour

        {

            private Zombie zombie;

            public bool isShoot;

            public float ShootTime = 20f;

  

            private Zombie ZombieComponent

            {

                get

                {

                    if (zombie == null)

                        zombie = GetComponent<Zombie>();

                    return zombie;

                }

            }

  

            private void Update()

            {

                ShootTime -= Time.deltaTime;

                isShoot = false;

  

                if (ShootTime <= 0f &&

                    GameAPP.theGameStatus == null &&

                    !ZombieComponent.isMindControlled &&

                    ZombieComponent.freezeTimer <= 0f &&

                    ZombieComponent.butterTimer <= 0f &&

                    !ZombieComponent.isPortaled &&

                    ZombieComponent != null)

                {

                    isShoot = true;

                    ZombieComponent.anim.SetTrigger("Shoot");

                    ShootTime = 20f;

                }

            }

  

            public void AnimShoot()

            {

                if (!IsZombieValid(ZombieComponent)) return;

  

                var createBullet = GetCreateBullet();

                if (createBullet != null)

                {

                    Vector3 position = transform.position;

                    int row = GetZombieRow(ZombieComponent);

                    // 创建玉米加农炮子弹

                    Bullet bullet = createBullet.CreateBullet(position.x, position.y, row,

                        Plugin.CobCannonBulletType, BulletMoveWay.Throw, false);

                    if (bullet != null)

                    {

                        SetBulletDamage(bullet, 1800); // 高伤害

                        // 寻找目标植物

                        var plants = GetAllPlants();

                        Plant targetPlant = null;

                        foreach (var plant in plants)

                        {

                            if (plant != null && IsPlantValid(plant) &&

                                GetPlantGameObject(plant).activeInHierarchy)

                            {

                                PlantType plantType = GetPlantType(plant);

                                var plantData = GetPlantData(plantType);

                                if (plantData != null && GetPlantHealth(plantData) > 0)

                                {

                                    targetPlant = plant;

                                    break;

                                }

                            }

                        }

                        if (targetPlant != null)

                        {

                            Vector2 targetPos = new Vector2(GetPlantRow(targetPlant), GetPlantColumn(targetPlant));

                            SetBulletTarget(bullet, targetPos);

                        }

                    }

                }

            }

        }

  

        // 西瓜加农炮巨人行为类

        public class MelonCannonGargantuar : MonoBehaviour

        {

            private Zombie zombie;

            public bool isShoot;

            public float ShootTime = 20f;

  

            private Zombie ZombieComponent

            {

                get

                {

                    if (zombie == null)

                        zombie = GetComponent<Zombie>();

                    return zombie;

                }

            }

  

            private void Update()

            {

                ShootTime -= Time.deltaTime;

                isShoot = false;

  

                if (ShootTime <= 0f &&

                    GameAPP.theGameStatus == null &&

                    ZombieComponent.freezeTimer <= 0f &&

                    ZombieComponent.butterTimer <= 0f &&

                    !ZombieComponent.isPortaled &&

                    ZombieComponent != null)

                {

                    isShoot = true;

                    ZombieComponent.anim.SetTrigger("Shoot");

                    ShootTime = 20f;

                }

            }

  

            public void AnimShoot()

            {

                if (!IsZombieValid(ZombieComponent)) return;

  

                var createBullet = GetCreateBullet();

                if (createBullet != null)

                {

                    Vector3 position = transform.position;

                    int row = GetZombieRow(ZombieComponent);

                    // 创建西瓜加农炮子弹

                    Bullet bullet = createBullet.CreateBullet(position.x, position.y, row,

                        Plugin.MelonCannonBulletType, BulletMoveWay.Throw, false);

                    if (bullet != null)

                    {

                        SetBulletDamage(bullet, 2000); // 更高伤害，带溅射

                        // 随机选择目标或创建额外僵尸

                        Random random = new Random();

                        if (random.Next(0, 100) < 30) // 30%几率召唤额外僵尸

                        {

                            var createZombie = GetCreateZombie();

                            if (createZombie != null)

                            {

                                createZombie.CreateZombie(row, ZombieType.imp, 10f, false);

                            }

                        }

                    }

                }

            }

        }

  

        // Harmony补丁类

        [HarmonyPatch(typeof(GameAPP), "Awake")]

        public class GameAPPAwakePatch

        {

            [HarmonyPostfix]

            public static void Postfix()

            {

                // 游戏初始化时加载自定义内容

                Plugin.LoadCannonGargantuar();

            }

        }

  

        [HarmonyPatch(typeof(CreateZombie), "SetZombie")]

        public class CreateZombieSetZombiePatch

        {

            [HarmonyPostfix]

            public static void Postfix(ref ZombieType theZombieType)

            {

                // 确保自定义僵尸类型被正确设置

                if (theZombieType == Plugin.CobCannonGargantuarType ||

                    theZombieType == Plugin.MelonCannonGargantuarType)

                {

                    // 自定义处理

                }

            }

        }

  

        [HarmonyPatch(typeof(TypeMgr), "IsGargantuar")]

        public class TypeMgrIsBossZombiePatch

        {

            [HarmonyPostfix]

            public static void Postfix(ref ZombieType theZombieType, ref bool __result)

            {

                // 将自定义僵尸标记为巨人类型

                if (theZombieType == Plugin.CobCannonGargantuarType ||

                    theZombieType == Plugin.MelonCannonGargantuarType)

                {

                    __result = true;

                }

            }

        }

  

        [HarmonyPatch(typeof(Bullet_cannon), "HitLand")]

        public class Bullet_cannonHitLandPatch

        {

            [HarmonyPrefix]

            public static void Prefix(Bullet_cannon __instance)

            {

                // 处理自定义子弹的碰撞逻辑

                BulletType bulletType = GetBulletType(__instance);

                if (bulletType == Plugin.CobCannonBulletType)

                {

                    // 玉米加农炮子弹效果 - 大范围伤害

                    HandleCobCannonImpact(__instance);

                }

                else if (bulletType == Plugin.MelonCannonBulletType)

                {

                    // 西瓜加农炮子弹效果 - 溅射伤害

                    HandleMelonCannonImpact(__instance);

                }

            }

  

            private static void HandleCobCannonImpact(Bullet_cannon bullet)

            {

                Vector2 impactPos = GetBulletPosition(bullet);

                float damageRadius = 3f;

                // 对范围内的所有植物造成伤害

                var plants = GetPlantsInArea(impactPos, damageRadius);

                foreach (var plant in plants)

                {

                    if (plant != null)

                    {

                        ApplyDamageToPlant(plant, 1800, 1);

                    }

                }

                // 创建爆炸效果

                CreateExplosionEffect(impactPos, 2);

            }

  

            private static void HandleMelonCannonImpact(Bullet_cannon bullet)

            {

                Vector2 impactPos = GetBulletPosition(bullet);

                float damageRadius = 4f;

                // 对范围内的所有植物造成溅射伤害

                var plants = GetPlantsInArea(impactPos, damageRadius);

                foreach (var plant in plants)

                {

                    if (plant != null)

                    {

                        ApplyDamageToPlant(plant, 800, 1); // 较低的单体伤害但范围更大

                    }

                }

                // 创建更大的爆炸效果

                CreateExplosionEffect(impactPos, 3);

            }

        }

  

        [HarmonyPatch(typeof(AlmanacMgrZombie), "InitNameAndInfoFromJson")]

        public class AlmanacMgrInitNameAndInfoFromJsonPatch

        {

            [HarmonyPostfix]

            public static void Postfix(AlmanacMgrZombie __instance)

            {

                // 在图鉴中添加自定义僵尸的信息

                ZombieType zombieType = GetZombieType(__instance);

                if (zombieType == Plugin.CobCannonGargantuarType)

                {

                    Transform infoTransform = GetInfoTransform(__instance);

                    if (infoTransform != null)

                    {

                        TMP_Text nameText = infoTransform.Find("NameText").GetComponent<TMP_Text>();

                        TMP_Info infoText = infoTransform.Find("InfoText").GetComponent<TMP_Text>();

                        if (nameText != null)

                            nameText.text = "Cob Cannon Gargantuar";

                        if (infoText != null)

                            infoText.text = "Fires powerful corn cob projectiles that devastate plants in a large area.";

                    }

                }

                else if (zombieType == Plugin.MelonCannonGargantuarType)

                {

                    Transform infoTransform = GetInfoTransform(__instance);

                    if (infoTransform != null)

                    {

                        TMP_Text nameText = infoTransform.Find("NameText").GetComponent<TMP_Text>();

                        TMP_Info infoText = infoTransform.Find("InfoText").GetComponent<TMP_Text>();

                        if (nameText != null)

                            nameText.text = "Melon Cannon Gargantuar";

                        if (infoText != null)

                            infoText.text = "Launches explosive melons that cause splash damage and can summon additional zombies.";

                    }

                }

            }

        }

  

        // 辅助方法占位符 - 这些需要根据实际游戏API实现

        private static bool IsZombieValid(Zombie zombie) => zombie != null;

        private static CreateBullet GetCreateBullet() => CreateBullet.Instance;

        private static int GetZombieRow(Zombie zombie) => zombie.row;

        private static void SetBulletDamage(Bullet bullet, int damage) { }

        private static List<Plant> GetAllPlants() => new List<Plant>();

        private static bool IsPlantValid(Plant plant) => plant != null;

        private static GameObject GetPlantGameObject(Plant plant) => plant.gameObject;

        private static PlantType GetPlantType(Plant plant) => plant.plantType;

        private static PlantDataLoader.PlantData_ GetPlantData(PlantType plantType) => null;

        private static int GetPlantHealth(PlantDataLoader.PlantData_ plantData) => 0;

        private static int GetPlantRow(Plant plant) => plant.row;

        private static int GetPlantColumn(Plant plant) => plant.column;

        private static void SetBulletTarget(Bullet bullet, Vector2 target) { }

        private static CreateZombie GetCreateZombie() => CreateZombie.Instance;

        private static BulletType GetBulletType(Bullet bullet) => bullet.bulletType;

        private static Vector2 GetBulletPosition(Bullet bullet) => bullet.transform.position;

        private static List<Plant> GetPlantsInArea(Vector2 position, float radius) => new List<Plant>();

        private static void ApplyDamageToPlant(Plant plant, int damage, int damageType) { }

        private static void CreateExplosionEffect(Vector2 position, int effectType) { }

        private static ZombieType GetZombieType(AlmanacMgrZombie almanac) => almanac.zombieType;

        private static Transform GetInfoTransform(AlmanacMgrZombie almanac) => almanac.transform;

    }

}
```